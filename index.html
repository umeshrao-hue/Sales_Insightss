<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Insights Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill=%23ffffff opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      z-index: -1;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .form-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    h4 {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e8ecef;
      border-radius: 12px;
      font-size: 16px;
      background: #ffffff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
      transform: translateY(-2px);
    }

    .date-range-container {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-range-container input {
      flex: 1;
      min-width: 150px;
    }

    .date-range-separator {
      color: #7f8c8d;
      font-weight: 600;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    button:disabled {
      background: linear-gradient(135deg, #bdc3c7, #95a5a6);
      cursor: not-allowed;
      transform: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .results-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .results-container.visible {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .results-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .results-title {
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .results-subtitle {
      color: #7f8c8d;
      font-size: 14px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
      background: #2ecc71;
      color: white;
    }

    .section {
      background: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-title {
      color: #667eea;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e8ecef;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      overflow-x: auto;
      display: block;
    }

    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e8ecef;
    }

    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      color: #2c3e50;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .table-heading {
      color: #2c3e50;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .new-result-alert {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .impact-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .impact-high {
      background: #e74c3c;
      color: white;
    }

    .impact-medium {
      background: #f39c12;
      color: white;
    }

    .impact-low {
      background: #95a5a6;
      color: white;
    }

    .training-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .priority-critical {
      background: #c0392b;
      color: white;
    }

    .priority-high {
      background: #e74c3c;
      color: white;
    }

    .priority-medium {
      background: #f39c12;
      color: white;
    }

    .priority-low {
      background: #2ecc71;
      color: white;
    }

    .resolution-rate {
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .rate-good {
      background: #d5f4e6;
      color: #27ae60;
    }

    .rate-poor {
      background: #fadbd8;
      color: #e74c3c;
    }

    .download-pdf-btn {
      width: auto;
      padding: 12px 30px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      margin: 20px auto;
      display: block;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
    }

    .download-pdf-btn:hover {
      box-shadow: 0 8px 25px rgba(46, 204, 113, 0.6);
    }

    .competitor-badge {
      background: #3498db;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      margin: 2px;
      display: inline-block;
    }

    @media (max-width: 768px) {
      .form-container, .results-container {
        padding: 30px 20px;
      }

      .date-range-container {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Form Section -->
    <div class="form-container">
      <h2>Sales Insights Report</h2>
      <h4>Get powerful insights fast, simple, and reliable</h4>

      <form id="insightsForm">
        <div class="form-group">
          <label for="vertical">Vertical</label>
          <select id="vertical" name="vertical">
            <option value="">-- Select Vertical --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="counselorEmail">Counselor Email</label>
          <select id="counselorEmail" name="counselorEmail">
            <option value="">-- Select Counselor Email --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ProductId">Product Id</label>
          <select id="ProductIdName" name="ProductIdName">
            <option value="">-- Select Product Id --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ProductType">Product Type</label>
          <select id="ProductTypeName" name="ProductTypeName">
            <option value="">-- Select Product Type --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="email">Email Address (Insight)</label>
          <input type="email" id="email" name="email" placeholder="Enter email manually">
        </div>

        <div class="form-group">
          <label>Date Range</label>
          <div class="date-range-container">
            <input type="date" id="startDate" name="startDate">
            <span class="date-range-separator">to</span>
            <input type="date" id="endDate" name="endDate">
          </div>
        </div>

        <button type="submit" id="submitBtn">Generate Report</button>
      </form>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="resultsContainer">
      <div class="results-header">
        <h2 class="results-title">Analysis Results</h2>
        <p class="results-subtitle">Your insights are ready</p>
        <button class="download-pdf-btn" id="downloadPdfBtn" onclick="downloadPDF()">
          Download Insights as PDF
        </button>
      </div>
      <div id="resultsContent"></div>
    </div>
  </div>

  <script>
    let records = [];

    async function fetchWebhookData() {
      try {
        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/fa3c1167-7102-4fdf-8250-d8c3271907cd",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          }
        );
        const data = await response.json();
        console.log("Webhook data received:", data);
        return data;
      } catch (err) {
        console.error("Error fetching webhook data:", err);
      }
    }

    async function loadData() {
      try {
        await fetchWebhookData();

        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/edd2e07e-4d02-4047-890d-2a3affd0201c?ts=" + Date.now()
        );
        records = await response.json();
        console.log("Fetched records:", records);

        const verticalSelect = document.getElementById("vertical");
        verticalSelect.innerHTML = '<option value="">-- Select Vertical --</option>';
        const uniqueCriteria = [...new Set(records.map(r => (r["Vertical"] || "").trim()).filter(Boolean))];
        uniqueCriteria.forEach(criteria => {
          const opt = document.createElement("option");
          opt.value = criteria;
          opt.textContent = criteria;
          verticalSelect.appendChild(opt);
        });

        const counselorSelect = document.getElementById("counselorEmail");
        counselorSelect.innerHTML = '<option value="">-- Select Counselor Email --</option>';
        const uniqueCounselorEmails = [...new Set(records.map(r => (r["Email ID"] || "").trim()).filter(Boolean))];
        uniqueCounselorEmails.forEach(email => {
          const opt = document.createElement("option");
          opt.value = email;
          opt.textContent = email;
          counselorSelect.appendChild(opt);
        });

        const productIdSelect = document.getElementById("ProductIdName");
        productIdSelect.innerHTML = '<option value="">-- Select Product Id --</option>';
        const uniqueProductIds = [...new Set(records.map(r => (r["Product Id"] || "").toString().trim()).filter(Boolean))];
        uniqueProductIds.forEach(productId => {
          const opt = document.createElement("option");
          opt.value = productId;
          opt.textContent = productId;
          productIdSelect.appendChild(opt);
        });

        const productTypeSelect = document.getElementById("ProductTypeName");
        productTypeSelect.innerHTML = '<option value="">-- Select Product Type --</option>';
        const uniqueProductTypes = [...new Set(
          records.map(r => {
            const productType = r["Product Type"] || "";
            return productType.toString().trim();
          })
            .filter(productType =>
              productType &&
              productType.toLowerCase() !== "yes" &&
              productType.toLowerCase() !== "no" &&
              productType !== "true" &&
              productType !== "false"
            )
        )];

        uniqueProductTypes.sort().forEach(productType => {
          const opt = document.createElement("option");
          opt.value = productType;
          opt.textContent = productType;
          productTypeSelect.appendChild(opt);
        });

        if (uniqueProductTypes.length === 0) {
          const opt = document.createElement("option");
          opt.value = "Live Classes";
          opt.textContent = "Live Classes";
          productTypeSelect.appendChild(opt);
        }

      } catch (err) {
        console.error("Error fetching data:", err);
        alert("Error loading data. Please refresh the page and try again.");
      }
    }

    window.addEventListener("load", loadData);

    document.getElementById("insightsForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.innerHTML;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Generating Report...';

      const payload = {
        vertical: document.getElementById("vertical").value,
        counselorEmail: document.getElementById("counselorEmail").value,
        productId: document.getElementById("ProductIdName").value,
        productType: document.getElementById("ProductTypeName").value,
        email: document.getElementById("email").value,
        startDate: formatDate(document.getElementById("startDate").value),
        endDate: formatDate(document.getElementById("endDate").value),
      };

      console.log("Submitting payload:", payload);

      try {
        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/c84b0531-7b76-4ea7-97bc-4f8539b93798",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );

        if (response.ok) {
          const analyticsData = await response.json();
          console.log("Analytics data received:", analyticsData);
          displayAnalytics(analyticsData);

          document.getElementById("resultsContainer").scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (err) {
        console.error("Error submitting form:", err);
        alert("Failed to submit request. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    function displayAnalytics(data) {
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsContent = document.getElementById("resultsContent");

      console.log("Raw data received:", data);

      let processedData = data;

      if (Array.isArray(processedData)) {
        processedData = processedData[0];
      }

      if (processedData && processedData.body) {
        processedData = processedData.body;
        if (Array.isArray(processedData)) {
          processedData = processedData[0];
        }
      }

      console.log("Processed data:", processedData);

      let html = '<div class="new-result-alert">Analysis Report Generated Successfully!</div>';

      // Metadata Table - KEEP ALL FIELDS
      if (processedData.metadata) {
        const meta = processedData.metadata;
        html += `
          <div class="section">
            <h3 class="table-heading">Analysis Overview</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Total Calls Analyzed</strong></td>
                  <td>${meta.totalCallsAnalyzed || 0}</td>
                </tr>
                <tr>
                  <td><strong>Analysis Date</strong></td>
                  <td>2025-10-06</td>
                </tr>
                <tr>
                  <td><strong>Statistical Confidence</strong></td>
                  <td>${meta.statisticalConfidence || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Data Reliability Score</strong></td>
                  <td>${meta.dataReliabilityScore || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Statistical Validity</strong></td>
                  <td>${meta.statisticalValidity || 'N/A'}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }

      // NEW: Insights Section
      if (processedData.insights) {
        const insights = processedData.insights;
        html += `
          <div class="section">
            <h3 class="table-heading">Business Insights</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Insight Category</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                ${insights.industryContext ? `
                <tr>
                  <td><strong>Industry Context</strong></td>
                  <td>${insights.industryContext}</td>
                </tr>
                ` : ''}
                ${insights.primaryProductsDiscussed ? `
                <tr>
                  <td><strong>Primary Products Discussed</strong></td>
                  <td>${Array.isArray(insights.primaryProductsDiscussed) ? insights.primaryProductsDiscussed.join(', ') : insights.primaryProductsDiscussed}</td>
                </tr>
                ` : ''}
              </tbody>
            </table>
          </div>
        `;
      }

      // Call Outcomes Table - ADD Call Date column
      if (processedData.callOutcomes && processedData.callOutcomes.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Call Outcomes</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Outcome Category</th>
                  <th>Call Count</th>
                  <th>Percentage</th>
                  <th>Sample Size</th>
                  <th>Call Date</th>
                  <th>Business Impact</th>
                  <th>Key Indicators</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.callOutcomes.forEach(outcome => {
          html += `
            <tr>
              <td><strong>${outcome.outcomeCategory}</strong></td>
              <td>${outcome.callCount}</td>
              <td>${outcome.percentage}</td>
              <td>${outcome.sampleSize}</td>
              <td>${outcome.callDate || 'N/A'}</td>
              <td><span class="impact-badge impact-${outcome.businessImpact.toLowerCase()}">${outcome.businessImpact}</span></td>
              <td>${outcome.keyIndicators}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Handle both "objections" and "objectionsAnalysis" - ADD Call Date and Competitor columns
      const objectionsData = processedData.objectionsAnalysis || processedData.objections;
      if (objectionsData && objectionsData.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Objections Analysis</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Specific Type</th>
                  <th>Total Occurrences</th>
                  <th>Calls Affected</th>
                  <th>% of Total Calls</th>
                  <th>Call Date</th>
                  <th>Competitor</th>
                  <th>Resolution Rate</th>
                  <th>Evidence Summary</th>
                </tr>
              </thead>
              <tbody>
        `;

        objectionsData.forEach(obj => {
          const resRate = parseFloat(obj.resolutionRate) || 0;
          const competitor = obj.competitor || 'N/A';
          html += `
            <tr>
              <td><strong>${obj.objectionCategory}</strong></td>
              <td>${obj.specificType}</td>
              <td>${obj.totalOccurrences}</td>
              <td>${obj.uniqueCallsAffected}</td>
              <td>${obj.percentOfTotalCalls}</td>
              <td>${obj.callDate || 'N/A'}</td>
              <td>${competitor !== 'N/A' ? competitor.split(',').map(c => `<span class="competitor-badge">${c.trim()}</span>`).join(' ') : 'N/A'}</td>
              <td><span class="resolution-rate rate-${resRate >= 50 ? 'good' : 'poor'}">${obj.resolutionRate}%</span></td>
              <td>${obj.evidenceSummary}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }   
      // Handle both "performanceScores" and "callsPerformanceScore" - KEEP ALL FIELDS + ADD NEW ONES
      const performanceData = processedData.callsPerformanceScore || processedData.performanceScores;
      if (performanceData && performanceData.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Calls Performance Score</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Skill Dimension</th>
                  ${performanceData[0].averageScore !== undefined ? '<th>Average Score</th>' : ''}
                  ${performanceData[0].maxScore !== undefined ? '<th>Max Score</th>' : ''}
                  ${performanceData[0].callsEvaluated !== undefined ? '<th>Calls Evaluated</th>' : ''}
                  ${performanceData[0].scoreDistribution ? '<th>Critical Gap</th><th>Needs Improvement</th><th>Proficient</th>' : ''}
                  ${performanceData[0].scoreDistribution && performanceData[0].scoreDistribution.low !== undefined ? '<th>Low/Medium/High</th>' : ''}
                  <th>Critical Gap %</th>
                  <th>Training Priority</th>
                  <th>Evidence Summary</th>
                  ${performanceData[0].commonIssues ? '<th>Common Issues</th>' : ''}
                </tr>
              </thead>
              <tbody>
        `;

        performanceData.forEach(score => {
          const dist = score.scoreDistribution || {};
          html += `
            <tr>
              <td><strong>${score.skillDimension}</strong></td>
              ${score.averageScore !== undefined ? `<td>${score.averageScore}</td>` : ''}
              ${score.maxScore !== undefined ? `<td>${score.maxScore}</td>` : ''}
              ${score.callsEvaluated !== undefined ? `<td>${score.callsEvaluated}</td>` : ''}
              ${dist.criticalGap !== undefined ? `<td>${dist.criticalGap}</td>` : ''}
              ${dist.needsImprovement !== undefined ? `<td>${dist.needsImprovement}</td>` : ''}
              ${dist.proficient !== undefined ? `<td>${dist.proficient}</td>` : ''}
              ${dist.low !== undefined ? `<td>${dist.low}/${dist.medium}/${dist.high}</td>` : ''}
              <td>${score.criticalGapPercentage || 'N/A'}</td>
              <td><span class="training-priority priority-${score.trainingPriority.toLowerCase()}">${score.trainingPriority}</span></td>
              <td>${score.evidenceSummary}</td>
              ${score.commonIssues ? `<td><ul style="margin:0; padding-left:20px;">${score.commonIssues.map(issue => `<li>${issue}</li>`).join('')}</ul></td>` : ''}
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Customer Segments Table - ADD Competitor column
      if (processedData.customerSegments && processedData.customerSegments.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Customer Segments</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Segment Name</th>
                  <th>Call Count</th>
                  <th>% of Total</th>
                  <th>Behavioral Markers</th>
                  <th>Key Concerns</th>
                  <th>Competitors</th>
                  <th>Decision Timeframe</th>
                  <th>Conversion Likelihood</th>
                  <th>Recommended Approach</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.customerSegments.forEach(segment => {
          const competitors = segment.primaryCompetitors ? 
            (Array.isArray(segment.primaryCompetitors) ? segment.primaryCompetitors.join(', ') : segment.primaryCompetitors) : 'N/A';
          html += `
            <tr>
              <td><strong>${segment.segmentName}</strong></td>
              <td>${segment.callCount}</td>
              <td>${segment.percentOfTotal}</td>
              <td>${segment.behavioralMarkers}</td>
              <td>${Array.isArray(segment.keyConcerns) ? segment.keyConcerns.join(', ') : segment.keyConcerns}</td>
              <td>${competitors !== 'N/A' ? competitors.split(',').map(c => `<span class="competitor-badge">${c.trim()}</span>`).join(' ') : 'N/A'}</td>
              <td>${segment.decisionTimeframe}</td>
              <td><strong>${segment.conversionLikelihood}</strong></td>
              <td>${segment.recommendedApproach}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Handle both "disinterestReasons" and "notInterestedReasons" - ADD Competitor column
      const notInterestedData = processedData.notInterestedReasons || processedData.disinterestReasons;
      if (notInterestedData && notInterestedData.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Not Interested Reasons</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Reason</th>
                  <th>Explicit Mentions</th>
                  <th>Implied Cases</th>
                  <th>Total Calls</th>
                  <th>% of Total Calls</th>
                  <th>Competitor</th>
                  <th>Controllable</th>
                  <th>Mitigation Strategy</th>
                </tr>
              </thead>
              <tbody>
        `;

        notInterestedData.forEach(reason => {
          const competitor = reason.competitor || 'N/A';
          html += `
            <tr>
              <td><strong>${reason.rank}</strong></td>
              <td>${reason.reason}</td>
              <td>${reason.explicitMentions}</td>
              <td>${reason.impliedCases || 0}</td>
              <td>${reason.totalCalls}</td>
              <td>${reason.percentOfTotalCalls}</td>
              <td>${competitor !== 'N/A' ? competitor.split(',').map(c => `<span class="competitor-badge">${c.trim()}</span>`).join(' ') : 'N/A'}</td>
              <td>${reason.controllable}</td>
              <td>${reason.mitigationStrategy}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Objection Resolution Table - KEEP ALL FIELDS
      if (processedData.objectionResolution && processedData.objectionResolution.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Objection Resolution Analysis</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Objection Type</th>
                  <th>Total Occurrences</th>
                  <th>Successfully Handled</th>
                  <th>Success Rate</th>
                  ${processedData.objectionResolution[0].averageResponseQuality !== undefined ? '<th>Avg Response Quality</th>' : ''}
                  ${processedData.objectionResolution[0].maxQuality !== undefined ? '<th>Max Quality</th>' : ''}
                  <th>Training Gap</th>
                  <th>Poor Response Indicator</th>
                  <th>Good Response Indicator</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.objectionResolution.forEach(res => {
          html += `
            <tr>
              <td><strong>${res.objectionType}</strong></td>
              <td>${res.totalOccurrences}</td>
              <td>${res.successfullyHandled}</td>
              <td><span class="resolution-rate rate-${parseFloat(res.successRate) >= 50 ? 'good' : 'poor'}">${res.successRate}%</span></td>
              ${res.averageResponseQuality !== undefined ? `<td>${res.averageResponseQuality}</td>` : ''}
              ${res.maxQuality !== undefined ? `<td>${res.maxQuality}</td>` : ''}
              <td>${res.trainingGapPercentage}</td>
              <td>${res.poorResponseIndicator}</td>
              <td>${res.goodResponseIndicator}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Performance Gaps Table
      if (processedData.performanceGaps && processedData.performanceGaps.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Performance Gaps</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Priority</th>
                  <th>Gap Category</th>
                  <th>Specific Issue</th>
                  <th>Frequency</th>
                  <th>% Calls Affected</th>
                  <th>Impact on Conversion</th>
                  <th>Training Priority</th>
                  <th>Recommended Intervention</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.performanceGaps.forEach(gap => {
          html += `
            <tr>
              <td><strong>${gap.priority}</strong></td>
              <td>${gap.gapCategory}</td>
              <td>${gap.specificIssue}</td>
              <td>${gap.frequency}</td>
              <td>${gap.percentCallsAffected}</td>
              <td>${gap.impactOnConversion}</td>
              <td><span class="training-priority priority-${gap.trainingPriority.toLowerCase()}">${gap.trainingPriority}</span></td>
              <td>${gap.recommendedIntervention}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Executive Summary - Conversion Funnel Table
      if (processedData.executiveSummary && processedData.executiveSummary.conversionFunnel) {
        html += `
          <div class="section">
            <h3 class="table-heading">Conversion Funnel</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Percentage</th>
                  <th>Count</th>
                  <th>Estimated Conversion</th>
                </tr>
              </thead>
              <tbody>
        `;

        Object.entries(processedData.executiveSummary.conversionFunnel).forEach(([key, value]) => {
          const stageName = key.replace(/([A-Z])/g, ' $1').trim();
          html += `
            <tr>
              <td><strong>${stageName.charAt(0).toUpperCase() + stageName.slice(1)}</strong></td>
              <td>${value.percentage || 'N/A'}</td>
              <td>${value.count || 0}</td>
              <td>${value.estimatedConversion || 'N/A'}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Top Conversion Blockers Table
      if (processedData.executiveSummary && processedData.executiveSummary.topConversionBlockers) {
        html += `
          <div class="section">
            <h3 class="table-heading">Top Conversion Blockers</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Blocker</th>
                  <th>% of Calls</th>
                  <th>Call Count</th>
                  <th>Evidence</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.executiveSummary.topConversionBlockers.forEach((blocker, index) => {
          html += `
            <tr>
              <td><strong>${index + 1}</strong></td>
              <td>${blocker.blocker}</td>
              <td>${blocker.percentOfCalls}</td>
              <td>${blocker.count}</td>
              <td>${blocker.evidence}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Performance Ratings Table - KEEP ALL FIELDS + ADD NEW STRUCTURE
      if (processedData.executiveSummary && processedData.executiveSummary.performanceRatings) {
        html += `
          <div class="section">
            <h3 class="table-heading">Performance Ratings Summary</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Performance Area</th>
                  ${processedData.executiveSummary.performanceRatings[Object.keys(processedData.executiveSummary.performanceRatings)[0]].score !== undefined ? '<th>Score</th>' : ''}
                  ${processedData.executiveSummary.performanceRatings[Object.keys(processedData.executiveSummary.performanceRatings)[0]].maxScore !== undefined ? '<th>Max Score</th>' : ''}
                  ${processedData.executiveSummary.performanceRatings[Object.keys(processedData.executiveSummary.performanceRatings)[0]].criticalGapPercentage !== undefined ? '<th>Critical Gap %</th>' : ''}
                  ${processedData.executiveSummary.performanceRatings[Object.keys(processedData.executiveSummary.performanceRatings)[0]].needImprovement !== undefined ? '<th>Needs Improvement</th>' : ''}
                </tr>
              </thead>
              <tbody>
        `;

        Object.entries(processedData.executiveSummary.performanceRatings).forEach(([key, value]) => {
          const areaName = key.replace(/([A-Z])/g, ' $1').trim();
          html += `
            <tr>
              <td><strong>${areaName.charAt(0).toUpperCase() + areaName.slice(1)}</strong></td>
              ${value.score !== undefined ? `<td>${value.score}</td>` : ''}
              ${value.maxScore !== undefined ? `<td>${value.maxScore}</td>` : ''}
              ${value.criticalGapPercentage !== undefined ? `<td>${value.criticalGapPercentage}</td>` : ''}
              ${value.needImprovement !== undefined ? `<td>${value.needImprovement ? 'Yes' : 'No'}</td>` : ''}
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Most Common Objections Table - ADD Competitor column
      if (processedData.executiveSummary && processedData.executiveSummary.mostCommonObjections) {
        html += `
          <div class="section">
            <h3 class="table-heading">Most Common Objections</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Objection</th>
                  <th>% of Calls</th>
                  <th>Count</th>
                  <th>Competitor</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.executiveSummary.mostCommonObjections.forEach((obj, index) => {
          const competitor = obj.competitor || 'N/A';
          html += `
            <tr>
              <td><strong>${index + 1}</strong></td>
              <td>${obj.objection}</td>
              <td>${obj.percentOfCalls}</td>
              <td>${obj.count}</td>
              <td>${competitor !== 'N/A' ? competitor.split(',').map(c => `<span class="competitor-badge">${c.trim()}</span>`).join(' ') : 'N/A'}</td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Immediate Action Plan Table
      if (processedData.immediateActionPlan && processedData.immediateActionPlan.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Immediate Action Plan</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Priority</th>
                  <th>Category</th>
                  <th>Issue</th>
                  <th>% Calls Affected</th>
                  <th>Current Impact</th>
                  <th>Recommended Fix</th>
                  <th>Expected Impact</th>
                  <th>Implementation Steps</th>
                </tr>
              </thead>
              <tbody>
        `;

        processedData.immediateActionPlan.forEach(action => {
          html += `
            <tr>
              <td><strong>${action.priority}</strong></td>
              <td>${action.category}</td>
              <td>${action.issue}</td>
              <td>${action.percentOfCalls}</td>
              <td>${action.currentImpact}</td>
              <td>${action.recommendedFix}</td>
              <td><strong>${action.expectedImpact}</strong></td>
              <td>
                <ul style="margin: 0; padding-left: 20px;">
                  ${action.implementationSteps.map(step => `<li>${step}</li>`).join('')}
                </ul>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table></div>`;
      }

      // Strategic Recommendations
      if (processedData.strategicRecommendations) {
        html += `<div class="section"><h3 class="table-heading">Strategic Recommendations</h3>`;
        
        const recommendations = processedData.strategicRecommendations;
        
        // Lead Quality Optimization
        if (recommendations.leadQualityOptimization) {
          const lqo = recommendations.leadQualityOptimization;
          html += `
            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Lead Quality Optimization</h4>
            <p style="margin-bottom: 10px;"><strong>Current State:</strong> ${lqo.currentState}</p>
            ${lqo.topDisqualificationReasons ? `
            <p style="margin-bottom: 10px;"><strong>Top Disqualification Reasons:</strong></p>
            <ul style="margin-left: 20px; margin-bottom: 10px;">
              ${lqo.topDisqualificationReasons.map(r => `<li>${r.reason}: ${r.percentage}</li>`).join('')}
            </ul>
            ` : ''}
            <p style="margin-bottom: 10px;"><strong>Recommendation:</strong> ${lqo.recommendation}</p>
            <p style="margin-bottom: 20px;"><strong>Expected Outcome:</strong> ${lqo.expectedOutcome}</p>
          `;
        }

        // Competitor Defense Strategy
        if (recommendations.competitorDefenseStrategy) {
          const cds = recommendations.competitorDefenseStrategy;
          html += `
            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Competitor Defense Strategy</h4>
            <p style="margin-bottom: 10px;"><strong>Current Gap:</strong> ${cds.currentGap}</p>
            ${cds.primaryCompetitors ? `
            <p style="margin-bottom: 10px;"><strong>Primary Competitors:</strong></p>
            <ul style="margin-left: 20px; margin-bottom: 10px;">
              ${cds.primaryCompetitors.map(c => `<li>${c.competitor}: ${c.frequency}</li>`).join('')}
            </ul>
            ` : ''}
            <p style="margin-bottom: 10px;"><strong>Recommended Framework:</strong> ${cds.recommendedFramework}</p>
            <p style="margin-bottom: 20px;"><strong>Expected Outcome:</strong> ${cds.expectedOutcome}</p>
          `;
        }

        // Objection Handling Framework
        if (recommendations.objectionHandlingFramework) {
          const ohf = recommendations.objectionHandlingFramework;
          html += `
            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Objection Handling Framework</h4>
            <p style="margin-bottom: 10px;"><strong>Current Gap:</strong> ${ohf.currentGap}</p>
            ${ohf.priorityObjections ? `
            <p style="margin-bottom: 10px;"><strong>Priority Objections:</strong></p>
            <ul style="margin-left: 20px; margin-bottom: 10px;">
              ${ohf.priorityObjections.map(o => `<li>${o.objection}: ${o.frequency}</li>`).join('')}
            </ul>
            ` : ''}
            <p style="margin-bottom: 10px;"><strong>Recommended Framework:</strong> ${ohf.recommendedFramework}</p>
            <p style="margin-bottom: 20px;"><strong>Expected Outcome:</strong> ${ohf.expectedOutcome}</p>
          `;
        }

        // Performance Monitoring
        if (recommendations.performanceMonitoring) {
          const pm = recommendations.performanceMonitoring;
          html += `
            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Performance Monitoring</h4>
            ${pm.weeklyKPIs ? `
            <p style="margin-bottom: 10px;"><strong>Weekly KPIs:</strong></p>
            <table class="data-table" style="margin-bottom: 15px;">
              <thead>
                <tr>
                  <th>KPI</th>
                  <th>Current</th>
                  <th>Target</th>
                </tr>
              </thead>
              <tbody>
                ${pm.weeklyKPIs.map(kpi => `
                  <tr>
                    <td>${kpi.kpi}</td>
                    <td>${kpi.current}</td>
                    <td>${kpi.target}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ` : ''}
            ${pm.dashboardAlerts ? `
            <p style="margin-bottom: 10px;"><strong>Dashboard Alerts:</strong></p>
            <ul style="margin-left: 20px; margin-bottom: 10px;">
              ${pm.dashboardAlerts.map(alert => `<li>${alert}</li>`).join('')}
            </ul>
            ` : ''}
          `;
        }

        html += `</div>`;
      }

      resultsContent.innerHTML = html;
      resultsContainer.classList.add('visible');

      setTimeout(() => {
        resultsContainer.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }, 300);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
    }

    async function downloadPDF() {
      const button = document.getElementById('downloadPdfBtn');
      const originalText = button.innerHTML;

      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span>Generating PDF...';

      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const content = document.getElementById('resultsContent');

        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        const timestamp = new Date().toISOString().split('T')[0];
        pdf.save(`Sales_Insights_Report_${timestamp}.pdf`);
      } catch (err) {
        console.error('Error generating PDF:', err);
        alert('Failed to generate PDF. Please try again.');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }
  </script>
</body>

</html>
              