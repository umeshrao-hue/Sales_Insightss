<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Insights Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; 
      padding: 20px;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill=%23ffffff opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
      z-index: -1;
    }
    
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .form-container { 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.2);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    h2 { 
      text-align: center; 
      margin-bottom: 10px; 
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    h4 {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
    }
    
    .form-group { 
      margin-bottom: 25px;
      position: relative;
    }
    
    label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #34495e;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input, select { 
      width: 100%; 
      padding: 14px 16px; 
      border: 2px solid #e8ecef;
      border-radius: 12px; 
      font-size: 16px;
      background: #ffffff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
      transform: translateY(-2px);
    }

    .date-range-container {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-range-container input {
      flex: 1;
      min-width: 150px;
    }

    .date-range-separator {
      color: #7f8c8d;
      font-weight: 600;
      font-size: 14px;
    }
    
    button { 
      width: 100%; 
      padding: 16px 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none; 
      border-radius: 12px; 
      font-size: 16px; 
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:hover { 
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    
    button:disabled {
      background: linear-gradient(135deg, #bdc3c7, #95a5a6);
      cursor: not-allowed;
      transform: none;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Results Section */
    .results-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      display: none;
    }

    .results-container.visible {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .results-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .results-title {
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .results-subtitle {
      color: #7f8c8d;
      font-size: 14px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 15px;
      background: #2ecc71;
      color: white;
    }

    .section {
      background: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .section-title {
      color: #667eea;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e8ecef;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .info-label {
      font-size: 11px;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
    }

    .json-view {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e8ecef;
    }

    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      color: #2c3e50;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .table-heading {
      color: #2c3e50;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .new-result-alert {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .form-container, .results-container {
        padding: 30px 20px;
      }
      
      .date-range-container {
        flex-direction: column;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Additional Styles for Analytics Display */
    .outcomes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .outcome-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #667eea;
      transition: transform 0.2s;
    }

    .outcome-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .outcome-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .outcome-header h3 {
      color: #2c3e50;
      font-size: 18px;
      margin: 0;
    }

    .outcome-percentage {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 16px;
    }

    .outcome-details {
      color: #34495e;
      font-size: 14px;
      line-height: 1.8;
    }

    .outcome-details p {
      margin: 8px 0;
    }

    .impact-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .impact-high {
      background: #e74c3c;
      color: white;
    }

    .impact-medium {
      background: #f39c12;
      color: white;
    }

    .impact-low {
      background: #95a5a6;
      color: white;
    }

    .performance-grid {
      display: grid;
      gap: 20px;
      margin-top: 20px;
    }

    .performance-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e8ecef;
    }

    .performance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .performance-header h4 {
      color: #2c3e50;
      font-size: 18px;
      margin: 0;
    }

    .training-priority {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .priority-high {
      background: #e74c3c;
      color: white;
    }

    .priority-medium {
      background: #f39c12;
      color: white;
    }

    .priority-low {
      background: #2ecc71;
      color: white;
    }

    .score-bar-container {
      position: relative;
      background: #e8ecef;
      height: 30px;
      border-radius: 15px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 1s ease-out;
      border-radius: 15px;
    }

    .score-label {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }

    .evidence {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .score-distribution {
      display: flex;
      gap: 15px;
      font-size: 13px;
      color: #7f8c8d;
    }

    .resolution-rate {
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .rate-good {
      background: #d5f4e6;
      color: #27ae60;
    }

    .rate-poor {
      background: #fadbd8;
      color: #e74c3c;
    }

    .segments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .segment-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e8ecef;
    }

    .segment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e8ecef;
    }

    .segment-header h4 {
      color: #2c3e50;
      margin: 0;
    }

    .segment-percent {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-weight: 600;
    }

    .conversion-badge {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .recommendation-box {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }

    .recommendation-box strong {
      color: #667eea;
    }

    .funnel-section, .blockers-section {
      margin-bottom: 25px;
    }

    .funnel-section h4, .blockers-section h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .funnel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .funnel-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .funnel-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .funnel-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .funnel-count {
      font-size: 14px;
      opacity: 0.8;
    }

    .funnel-conversion {
      margin-top: 8px;
      font-size: 13px;
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 8px;
      display: inline-block;
    }

    .blocker-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #e74c3c;
    }

    .blocker-rank {
      background: #e74c3c;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .blocker-details {
      flex: 1;
    }

    .blocker-details strong {
      color: #2c3e50;
      font-size: 16px;
    }

    .blocker-evidence {
      color: #7f8c8d;
      font-size: 13px;
      margin-top: 5px;
    }

    .action-card {
      background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
      border: 2px solid #fed7d7;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .action-header {
      margin-bottom: 15px;
    }

    .action-priority {
      background: #e74c3c;
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
      display: inline-block;
    }

    .action-header h4 {
      color: #2c3e50;
      font-size: 20px;
      margin: 10px 0 0 0;
    }

    .action-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #7f8c8d;
    }

    .action-impact {
      color: #e74c3c;
      font-weight: 600;
    }

    .action-body p {
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .highlight {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    .implementation-steps {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .implementation-steps strong {
      color: #667eea;
      display: block;
      margin-bottom: 10px;
    }

    .implementation-steps ul {
      margin-left: 20px;
    }

    .implementation-steps li {
      margin-bottom: 8px;
      color: #2c3e50;
      line-height: 1.6;
    }
    .download-pdf-btn {
  width: auto;
  padding: 12px 30px;
  background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
  margin: 20px auto;
  display: block;
  box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
}

.download-pdf-btn:hover {
  box-shadow: 0 8px 25px rgba(46, 204, 113, 0.6);
}
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Form Section -->
    <div class="form-container">
      <h2>Sales Insights Report</h2>
      <h4>Get powerful insights fast, simple, and reliable</h4>

      <form id="insightsForm">
        <div class="form-group">
          <label for="vertical">Vertical</label>
          <select id="vertical" name="vertical">
            <option value="">-- Select Vertical --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="counselorEmail">Counselor Email</label>
          <select id="counselorEmail" name="counselorEmail">
            <option value="">-- Select Counselor Email --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ProductId">Product Id</label>
          <select id="ProductIdName" name="ProductIdName">
            <option value="">-- Select Product Id --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ProductType">Product Type</label>
          <select id="ProductTypeName" name="ProductTypeName">
            <option value="">-- Select Product Type --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="email">Email Address (Insight)</label>
          <input type="email" id="email" name="email" placeholder="Enter email manually">
        </div>

        <div class="form-group">
          <label>Date Range</label>
          <div class="date-range-container">
            <input type="date" id="startDate" name="startDate">
            <span class="date-range-separator">to</span>
            <input type="date" id="endDate" name="endDate">
          </div>
        </div>

        <button type="submit" id="submitBtn">Generate Report</button>
      </form>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="resultsContainer">
      <div class="results-header">
        <h2 class="results-title">Analysis Results</h2>
        <p class="results-subtitle">Your insights are ready</p>
        <button class="download-pdf-btn" id="downloadPdfBtn" onclick="downloadPDF()">
  Download Insights as PDF
</button>
      </div>
      <div id="resultsContent"></div>
    </div>
  </div>

  <script>
    let records = [];

    async function fetchWebhookData() {
      try {
        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/fa3c1167-7102-4fdf-8250-d8c3271907cd",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          }
        );
        const data = await response.json();
        console.log("Webhook data received:", data);
        return data;
      } catch (err) {
        console.error("Error fetching webhook data:", err);
      }
    }

    async function loadData() {
      try {
        await fetchWebhookData();

        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/edd2e07e-4d02-4047-890d-2a3affd0201c?ts=" + Date.now()
        );
        records = await response.json();
        console.log("Fetched records:", records);

        const verticalSelect = document.getElementById("vertical");
        verticalSelect.innerHTML = '<option value="">-- Select Vertical --</option>';
        const uniqueCriteria = [...new Set(records.map(r => (r["Vertical"] || "").trim()).filter(Boolean))];
        uniqueCriteria.forEach(criteria => {
          const opt = document.createElement("option");
          opt.value = criteria;
          opt.textContent = criteria;
          verticalSelect.appendChild(opt);
        });

        const counselorSelect = document.getElementById("counselorEmail");
        counselorSelect.innerHTML = '<option value="">-- Select Counselor Email --</option>';
        const uniqueCounselorEmails = [...new Set(records.map(r => (r["Email ID"] || "").trim()).filter(Boolean))];
        uniqueCounselorEmails.forEach(email => {
          const opt = document.createElement("option");
          opt.value = email;
          opt.textContent = email;
          counselorSelect.appendChild(opt);
        });

        const productIdSelect = document.getElementById("ProductIdName");
        productIdSelect.innerHTML = '<option value="">-- Select Product Id --</option>';
        const uniqueProductIds = [...new Set(records.map(r => (r["Product Id"] || "").toString().trim()).filter(Boolean))];
        uniqueProductIds.forEach(productId => {
          const opt = document.createElement("option");
          opt.value = productId;
          opt.textContent = productId;
          productIdSelect.appendChild(opt);
        });

        const productTypeSelect = document.getElementById("ProductTypeName");
        productTypeSelect.innerHTML = '<option value="">-- Select Product Type --</option>';
        const uniqueProductTypes = [...new Set(
          records.map(r => {
            const productType = r["Product Type"] || "";
            return productType.toString().trim();
          })
          .filter(productType => 
            productType && 
            productType.toLowerCase() !== "yes" && 
            productType.toLowerCase() !== "no" && 
            productType !== "true" && 
            productType !== "false"
          )
        )];
        
        uniqueProductTypes.sort().forEach(productType => {
          const opt = document.createElement("option");
          opt.value = productType;
          opt.textContent = productType;
          productTypeSelect.appendChild(opt);
        });

        if (uniqueProductTypes.length === 0) {
          const opt = document.createElement("option");
          opt.value = "Live Classes";
          opt.textContent = "Live Classes";
          productTypeSelect.appendChild(opt);
        }

      } catch (err) {
        console.error("Error fetching data:", err);
        alert("Error loading data. Please refresh the page and try again.");
      }
    }

    window.addEventListener("load", loadData);

    document.getElementById("insightsForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.innerHTML;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Generating Report...';

      const payload = {
        vertical: document.getElementById("vertical").value,
        counselorEmail: document.getElementById("counselorEmail").value,
        productId: document.getElementById("ProductIdName").value,
        productType: document.getElementById("ProductTypeName").value,
        email: document.getElementById("email").value,
        startDate: formatDate(document.getElementById("startDate").value),
        endDate: formatDate(document.getElementById("endDate").value),
      };

      console.log("Submitting payload:", payload);

      try {
        const response = await fetch(
          "https://n8n.srv965309.hstgr.cloud/webhook/c84b0531-7b76-4ea7-97bc-4f8539b93798",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );

        if (response.ok) {
          const analyticsData = await response.json();
          console.log("Analytics data received:", analyticsData);
          displayAnalytics(analyticsData);
          
          document.getElementById("resultsContainer").scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
          });
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (err) {
        console.error("Error submitting form:", err);
        alert("Failed to submit request. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    function displayAnalytics(data) {
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsContent = document.getElementById("resultsContent");
      
      console.log("Raw data received:", data);
      
      // Extract the actual data from various possible response structures
      let processedData = data;
      
      // If it's an array, get the first element
      if (Array.isArray(processedData)) {
        processedData = processedData[0];
      }
      
      // If there's a body property, extract it
      if (processedData && processedData.body) {
        processedData = processedData.body;
        // Check again if body is an array
        if (Array.isArray(processedData)) {
          processedData = processedData[0];
        }
      }
      
      console.log("Processed data:", processedData);
      
      let html = '<div class="new-result-alert">Analysis Report Generated Successfully!</div>';

      // Metadata Table
      if (processedData.metadata) {
        const meta = processedData.metadata;
        html += `
          <div class="section">
            <h3 class="table-heading">Analysis Overview</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Total Calls Analyzed</strong></td>
                  <td>${meta.totalCallsAnalyzed || 0}</td>
                </tr>
                <tr>
                  <td><strong>Successfully Parsed</strong></td>
                  <td>${meta.successfullyParsed || 0}</td>
                </tr>
                <tr>
                  <td><strong>Incomplete/Flagged</strong></td>
                  <td>${meta.incompleteOrFlagged || 0}</td>
                </tr>
                <tr>
                  <td><strong>Analysis Date</strong></td>
                  <td>${meta.analysisDate || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Statistical Confidence</strong></td>
                  <td>${meta.statisticalConfidence || 'N/A'}</td>
                </tr>
                <tr>
                  <td><strong>Data Reliability Score</strong></td>
                  <td>${meta.dataReliabilityScore || 'N/A'}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }

      // Call Outcomes Table
      if (processedData.callOutcomes && processedData.callOutcomes.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Call Outcomes</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Outcome Category</th>
                  <th>Call Count</th>
                  <th>Percentage</th>
                  <th>Sample Size</th>
                  <th>Business Impact</th>
                  <th>Key Indicators</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.callOutcomes.forEach(outcome => {
          html += `
            <tr>
              <td><strong>${outcome.outcomeCategory}</strong></td>
              <td>${outcome.callCount}</td>
              <td>${outcome.percentage}</td>
              <td>${outcome.sampleSize}</td>
              <td><span class="impact-badge impact-${outcome.businessImpact.toLowerCase()}">${outcome.businessImpact}</span></td>
              <td>${outcome.keyIndicators}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Objections Table
      if (processedData.objections && processedData.objections.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Objections Analysis</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Specific Type</th>
                  <th>Total Occurrences</th>
                  <th>Calls Affected</th>
                  <th>% of Total Calls</th>
                  <th>Resolution Rate</th>
                  <th>Evidence Summary</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.objections.forEach(obj => {
          const resRate = parseFloat(obj.resolutionRate) || 0;
          html += `
            <tr>
              <td><strong>${obj.objectionCategory}</strong></td>
              <td>${obj.specificType}</td>
              <td>${obj.totalOccurrences}</td>
              <td>${obj.uniqueCallsAffected}</td>
              <td>${obj.percentOfTotalCalls}</td>
              <td><span class="resolution-rate rate-${resRate >= 50 ? 'good' : 'poor'}">${obj.resolutionRate}%</span></td>
              <td>${obj.evidenceSummary}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Performance Scores Table
      if (processedData.performanceScores && processedData.performanceScores.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Performance Scores</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Skill Dimension</th>
                  <th>Average Score</th>
                  <th>Max Score</th>
                  <th>Calls Evaluated</th>
                  <th>Low/Medium/High</th>
                  <th>Critical Gap %</th>
                  <th>Training Priority</th>
                  <th>Evidence Summary</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.performanceScores.forEach(score => {
          html += `
            <tr>
              <td><strong>${score.skillDimension}</strong></td>
              <td>${score.averageScore}</td>
              <td>${score.maxScore}</td>
              <td>${score.callsEvaluated}</td>
              <td>${score.scoreDistribution.low}/${score.scoreDistribution.medium}/${score.scoreDistribution.high}</td>
              <td>${score.criticalGapPercentage}</td>
              <td><span class="training-priority priority-${score.trainingPriority.toLowerCase()}">${score.trainingPriority}</span></td>
              <td>${score.evidenceSummary}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Customer Segments Table
      if (processedData.customerSegments && processedData.customerSegments.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Customer Segments</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Segment Name</th>
                  <th>Call Count</th>
                  <th>% of Total</th>
                  <th>Behavioral Markers</th>
                  <th>Key Concerns</th>
                  <th>Decision Timeframe</th>
                  <th>Conversion Likelihood</th>
                  <th>Recommended Approach</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.customerSegments.forEach(segment => {
          html += `
            <tr>
              <td><strong>${segment.segmentName}</strong></td>
              <td>${segment.callCount}</td>
              <td>${segment.percentOfTotal}</td>
              <td>${segment.behavioralMarkers}</td>
              <td>${segment.keyConcerns.join(', ')}</td>
              <td>${segment.decisionTimeframe}</td>
              <td><span class="conversion-badge">${segment.conversionLikelihood}</span></td>
              <td>${segment.recommendedApproach}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Disinterest Reasons Table
      if (processedData.disinterestReasons && processedData.disinterestReasons.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Disinterest Reasons</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Reason</th>
                  <th>Explicit Mentions</th>
                  <th>Total Calls</th>
                  <th>% of Total Calls</th>
                  <th>Controllable</th>
                  <th>Mitigation Strategy</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.disinterestReasons.forEach(reason => {
          html += `
            <tr>
              <td><strong>${reason.rank}</strong></td>
              <td>${reason.reason}</td>
              <td>${reason.explicitMentions}</td>
              <td>${reason.totalCalls}</td>
              <td>${reason.percentOfTotalCalls}</td>
              <td>${reason.controllable}</td>
              <td>${reason.mitigationStrategy}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Objection Resolution Table
      if (processedData.objectionResolution && processedData.objectionResolution.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Objection Resolution Analysis</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Objection Type</th>
                  <th>Total Occurrences</th>
                  <th>Successfully Handled</th>
                  <th>Success Rate</th>
                  <th>Avg Response Quality</th>
                  <th>Training Gap</th>
                  <th>Poor Response Indicator</th>
                  <th>Good Response Indicator</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.objectionResolution.forEach(res => {
          html += `
            <tr>
              <td><strong>${res.objectionType}</strong></td>
              <td>${res.totalOccurrences}</td>
              <td>${res.successfullyHandled}</td>
              <td><span class="resolution-rate rate-${parseFloat(res.successRate) >= 50 ? 'good' : 'poor'}">${res.successRate}%</span></td>
              <td>${res.averageResponseQuality}/${res.maxQuality}</td>
              <td>${res.trainingGapPercentage}</td>
              <td>${res.poorResponseIndicator}</td>
              <td>${res.goodResponseIndicator}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Performance Gaps Table
      if (processedData.performanceGaps && processedData.performanceGaps.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Performance Gaps</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Priority</th>
                  <th>Gap Category</th>
                  <th>Specific Issue</th>
                  <th>Frequency</th>
                  <th>% Calls Affected</th>
                  <th>Impact on Conversion</th>
                  <th>Training Priority</th>
                  <th>Recommended Intervention</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.performanceGaps.forEach(gap => {
          html += `
            <tr>
              <td><strong>${gap.priority}</strong></td>
              <td>${gap.gapCategory}</td>
              <td>${gap.specificIssue}</td>
              <td>${gap.frequency}</td>
              <td>${gap.percentCallsAffected}</td>
              <td>${gap.impactOnConversion}</td>
              <td><span class="training-priority priority-${gap.trainingPriority.toLowerCase()}">${gap.trainingPriority}</span></td>
              <td>${gap.recommendedIntervention}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Executive Summary - Conversion Funnel Table
      if (processedData.executiveSummary && processedData.executiveSummary.conversionFunnel) {
        html += `
          <div class="section">
            <h3 class="table-heading">Conversion Funnel</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Percentage</th>
                  <th>Count</th>
                  <th>Estimated Conversion</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        Object.entries(processedData.executiveSummary.conversionFunnel).forEach(([key, value]) => {
          html += `
            <tr>
              <td><strong>${key.replace(/([A-Z])/g, ' $1').trim()}</strong></td>
              <td>${value.percentage || 'N/A'}</td>
              <td>${value.count || 0}</td>
              <td>${value.estimatedConversion || 'N/A'}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Top Conversion Blockers Table
      if (processedData.executiveSummary && processedData.executiveSummary.topConversionBlockers) {
        html += `
          <div class="section">
            <h3 class="table-heading">Top Conversion Blockers</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Blocker</th>
                  <th>% of Calls</th>
                  <th>Call Count</th>
                  <th>Evidence</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.executiveSummary.topConversionBlockers.forEach((blocker, index) => {
          html += `
            <tr>
              <td><strong>${index + 1}</strong></td>
              <td>${blocker.blocker}</td>
              <td>${blocker.percentOfCalls}</td>
              <td>${blocker.count}</td>
              <td>${blocker.evidence}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      // Immediate Action Plan Table
      if (processedData.immediateActionPlan && processedData.immediateActionPlan.length > 0) {
        html += `
          <div class="section">
            <h3 class="table-heading">Immediate Action Plan</h3>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Priority</th>
                  <th>Category</th>
                  <th>Issue</th>
                  <th>% Calls Affected</th>
                  <th>Current Impact</th>
                  <th>Recommended Fix</th>
                  <th>Expected Impact</th>
                  <th>Implementation Steps</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        processedData.immediateActionPlan.forEach(action => {
          html += `
            <tr>
              <td><strong>${action.priority}</strong></td>
              <td>${action.category}</td>
              <td>${action.issue}</td>
              <td>${action.percentOfCalls}</td>
              <td>${action.currentImpact}</td>
              <td>${action.recommendedFix}</td>
              <td><strong>${action.expectedImpact}</strong></td>
              <td>
                <ul style="margin: 0; padding-left: 20px;">
                  ${action.implementationSteps.map(step => `<li>${step}</li>`).join('')}
                </ul>
              </td>
            </tr>
          `;
        });
        
        html += `</tbody></table></div>`;
      }

      resultsContent.innerHTML = html;
      resultsContainer.classList.add('visible');
      
      // Scroll to results with a slight delay
      setTimeout(() => {
        resultsContainer.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }, 300);
    }

    function generateTableView(data) {
      if (data.length === 0) return '<p>No data available</p>';

      const allKeys = new Set();
      data.forEach(item => {
        if (typeof item === 'object' && item !== null) {
          Object.keys(item).forEach(key => allKeys.add(key));
        }
      });

      const keys = Array.from(allKeys);

      let html = '<table class="data-table"><thead><tr>';
      keys.forEach(key => {
        html += `<th>${key}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(item => {
        html += '<tr>';
        keys.forEach(key => {
          const value = item[key];
          const displayValue = typeof value === 'object' 
            ? JSON.stringify(value) 
            : value !== undefined && value !== null 
            ? value 
            : '-';
          html += `<td>${displayValue}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    function generateKeyValueView(data) {
      let html = '<table class="data-table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';

      for (const [key, value] of Object.entries(data)) {
        const displayValue = typeof value === 'object' 
          ? `<pre style="margin:0;">${JSON.stringify(value, null, 2)}</pre>` 
          : value;
        html += `<tr><td><strong>${key}</strong></td><td>${displayValue}</td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
    }
    async function downloadPDF() {
  const button = document.getElementById('downloadPdfBtn');
  const originalText = button.innerHTML;
  
  button.disabled = true;
  button.innerHTML = '<span class="loading-spinner"></span>Generating PDF...';

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const content = document.getElementById('resultsContent');
    
    const canvas = await html2canvas(content, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    });
    
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    const timestamp = new Date().toISOString().split('T')[0];
    pdf.save(`Sales_Insights_Report_${timestamp}.pdf`);
  } catch (err) {
    console.error('Error generating PDF:', err);
    alert('Failed to generate PDF. Please try again.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
  </script>
</body>
</html>